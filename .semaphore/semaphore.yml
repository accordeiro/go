version: v1.0
name: Test and build pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: "Test and build the go monorepo packages"
    task:
      prologue:
        commands:
          # Golang setup, required since we're building with Go versions < 1.11:
          - export "SEMAPHORE_GIT_DIR=$(go env GOPATH)/src/github.com/stellar/${SEMAPHORE_PROJECT_NAME}"
          - export "PATH=$(go env GOPATH)/bin:${PATH}"
          - mkdir -vp "${SEMAPHORE_GIT_DIR}" "$(go env GOPATH)/bin"

          # Installing dep and dependencies
          - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
          # TODO: cache dependencies
          - checkout
          - dep ensure -v
      jobs:
      - name: Check formatting / code on Go 1.12
        commands:
          - sem-version go 1.12
          - ./gofmt.sh
          - ./govet.sh

      - name: Run tests on Go 1.12
        commands:
          - sem-version go 1.12
          - ./support/scripts/run_tests
